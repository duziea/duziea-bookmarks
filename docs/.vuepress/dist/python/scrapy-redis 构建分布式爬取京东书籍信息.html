<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>scrapy-redis 构建分布式爬取京东书籍信息 | duziea-bookmarks</title>
    <meta name="description" content="stary hungry stay foolish">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.0ad23782.css" as="style"><link rel="preload" href="/assets/js/app.dabac77d.js" as="script"><link rel="preload" href="/assets/js/2.b1acc2ad.js" as="script"><link rel="preload" href="/assets/js/20.279c30ab.js" as="script"><link rel="prefetch" href="/assets/js/10.f6e3c06d.js"><link rel="prefetch" href="/assets/js/11.e9b83c1c.js"><link rel="prefetch" href="/assets/js/12.8444b5eb.js"><link rel="prefetch" href="/assets/js/13.d6b969bc.js"><link rel="prefetch" href="/assets/js/14.dc4c6754.js"><link rel="prefetch" href="/assets/js/15.98bf10eb.js"><link rel="prefetch" href="/assets/js/16.8046a3c0.js"><link rel="prefetch" href="/assets/js/17.51b84f9e.js"><link rel="prefetch" href="/assets/js/18.9cc3ef77.js"><link rel="prefetch" href="/assets/js/19.480e5dc0.js"><link rel="prefetch" href="/assets/js/21.8d029260.js"><link rel="prefetch" href="/assets/js/22.bd4e2089.js"><link rel="prefetch" href="/assets/js/23.1f0200c0.js"><link rel="prefetch" href="/assets/js/24.4e139f3d.js"><link rel="prefetch" href="/assets/js/25.dc2e9b6e.js"><link rel="prefetch" href="/assets/js/26.cc78e683.js"><link rel="prefetch" href="/assets/js/27.87c9010a.js"><link rel="prefetch" href="/assets/js/3.91de71b1.js"><link rel="prefetch" href="/assets/js/4.9e4e91b9.js"><link rel="prefetch" href="/assets/js/5.a9ae41ee.js"><link rel="prefetch" href="/assets/js/6.5a6eaa9f.js"><link rel="prefetch" href="/assets/js/7.30d57532.js"><link rel="prefetch" href="/assets/js/8.7765fee4.js"><link rel="prefetch" href="/assets/js/9.7c25486c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0ad23782.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">duziea-bookmarks</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/repository/" class="nav-link">库</a></div><div class="nav-item"><a href="/website/" class="nav-link">网站</a></div><div class="nav-item"><a href="/blog/" class="nav-link">Blog</a></div><div class="nav-item"><a href="/python/" class="nav-link router-link-active">python</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/repository/" class="nav-link">库</a></div><div class="nav-item"><a href="/website/" class="nav-link">网站</a></div><div class="nav-item"><a href="/blog/" class="nav-link">Blog</a></div><div class="nav-item"><a href="/python/" class="nav-link router-link-active">python</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>python</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/python/python爬取拉钩网招聘信息分析.html" class="sidebar-link">python爬取拉钩网招聘信息分析</a></li><li><a href="/python/Python selenium批量导出csdn文章.html" class="sidebar-link">Python selenium批量导出csdn文章</a></li><li><a href="/python/pyspider 安装踩坑记.html" class="sidebar-link">pyspider 安装踩坑记</a></li><li><a href="/python/pyspider 食用教程（1）.html" class="sidebar-link">pyspider 食用教程（1）</a></li><li><a href="/python/python爬qq音乐热评.html" class="sidebar-link">python爬qq音乐评论</a></li><li><a href="/python/python爬取企业信息.html" class="sidebar-link">python爬取企业信息</a></li><li><a href="/python/" class="sidebar-link">前言</a></li><li><a href="/python/scrapy-redis 构建分布式爬取京东书籍信息.html" class="active sidebar-link">scrapy-redis 构建分布式爬取京东书籍信息</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/scrapy-redis 构建分布式爬取京东书籍信息.html#setting-py配置" class="sidebar-link">setting.py配置</a></li><li class="sidebar-sub-header"><a href="/python/scrapy-redis 构建分布式爬取京东书籍信息.html#items-py" class="sidebar-link">items.py</a></li><li class="sidebar-sub-header"><a href="/python/scrapy-redis 构建分布式爬取京东书籍信息.html#book-py" class="sidebar-link">book.py</a></li><li class="sidebar-sub-header"><a href="/python/scrapy-redis 构建分布式爬取京东书籍信息.html#完整代码" class="sidebar-link">完整代码</a></li></ul></li><li><a href="/python/scrapy-redis源码解读.html" class="sidebar-link">scrapy-redis源码解读</a></li><li><a href="/python/scrapyd服务器跑爬虫+爬虫可视化.html" class="sidebar-link">scrapyd服务器跑爬虫+爬虫可视化</a></li><li><a href="/python/scrapy爬取识货网商品信息.html" class="sidebar-link">scrapy爬取识货网商品信息</a></li><li><a href="/python/极验滑动验证码破解.html" class="sidebar-link">极验滑动验证码破解</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="scrapy-redis-构建分布式爬取京东书籍信息"><a href="#scrapy-redis-构建分布式爬取京东书籍信息" class="header-anchor">#</a> scrapy-redis 构建分布式爬取京东书籍信息</h1> <p>上次介绍了scrapy-redis源码，这次实战一下。</p> <h2 id="setting-py配置"><a href="#setting-py配置" class="header-anchor">#</a> <strong>setting.py配置</strong></h2> <p>主要启用scrapy-redis的SCHEDULER，DUPEFILTER，redis地址</p> <p>其他的看需求，</p> <p>例如这里我启用了scrapy_redis.pipelines.RedisPipeline存储数据。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#---------------------scrapy-redis setting --------------</span>
<span class="token comment"># Enables scheduling storing requests queue in redis.</span>
SCHEDULER <span class="token operator">=</span> <span class="token string">&quot;scrapy_redis.scheduler.Scheduler&quot;</span>

<span class="token comment"># Ensure all spiders share same duplicates filter through redis.</span>
DUPEFILTER_CLASS <span class="token operator">=</span> <span class="token string">&quot;scrapy_redis.dupefilter.RFPDupeFilter&quot;</span>

<span class="token comment"># Default requests serializer is pickle, but it can be changed to any module</span>
<span class="token comment"># with loads and dumps functions. Note that pickle is not compatible between</span>
<span class="token comment"># python versions.</span>
<span class="token comment"># Caveat: In python 3.x, the serializer must return strings keys and support</span>
<span class="token comment"># bytes as values. Because of this reason the json or msgpack module will not</span>
<span class="token comment"># work by default. In python 2.x there is no such issue and you can use</span>
<span class="token comment"># 'json' or 'msgpack' as serializers.</span>
<span class="token comment">#SCHEDULER_SERIALIZER = &quot;scrapy_redis.picklecompat&quot;</span>

<span class="token comment"># Don't cleanup redis queues, allows to pause/resume crawls.</span>
SCHEDULER_PERSIST <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment"># Schedule requests using a priority queue. (default)</span>
<span class="token comment">#SCHEDULER_QUEUE_CLASS = 'scrapy_redis.queue.PriorityQueue'</span>

<span class="token comment"># Alternative queues.</span>
<span class="token comment">#SCHEDULER_QUEUE_CLASS = 'scrapy_redis.queue.FifoQueue'</span>
<span class="token comment">#SCHEDULER_QUEUE_CLASS = 'scrapy_redis.queue.LifoQueue'</span>

<span class="token comment"># Max idle time to prevent the spider from being closed when distributed crawling.</span>
<span class="token comment"># This only works if queue class is SpiderQueue or SpiderStack,</span>
<span class="token comment"># and may also block the same time when your spider start at the first time (because the queue is empty).</span>
<span class="token comment">#SCHEDULER_IDLE_BEFORE_CLOSE = 10</span>

<span class="token comment"># Store scraped item in redis for post-processing.</span>
ITEM_PIPELINES <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'scrapy_redis.pipelines.RedisPipeline'</span><span class="token punctuation">:</span> <span class="token number">300</span>
<span class="token punctuation">}</span>

<span class="token comment"># The item pipeline serializes and stores the items in this redis key.</span>
<span class="token comment">#REDIS_ITEMS_KEY = '%(spider)s:items'</span>

<span class="token comment"># The items serializer is by default ScrapyJSONEncoder. You can use any</span>
<span class="token comment"># importable path to a callable object.</span>
<span class="token comment">#REDIS_ITEMS_SERIALIZER = 'json.dumps'</span>

<span class="token comment"># Specify the host and port to use when connecting to Redis (optional).</span>
REDIS_HOST <span class="token operator">=</span> <span class="token string">'localhost'</span>
REDIS_PORT <span class="token operator">=</span> <span class="token number">6379</span>

<span class="token comment"># Specify the full Redis URL for connecting (optional).</span>
<span class="token comment"># If set, this takes precedence over the REDIS_HOST and REDIS_PORT settings.</span>
<span class="token comment">#REDIS_URL = 'redis://user:pass@hostname:9001'</span>

<span class="token comment"># Custom redis client parameters (i.e.: socket timeout, etc.)</span>
<span class="token comment">#REDIS_PARAMS  = {}</span>
<span class="token comment"># Use custom redis client class.</span>
<span class="token comment">#REDIS_PARAMS['redis_cls'] = 'myproject.RedisClient'</span>

<span class="token comment"># If True, it uses redis' ``spop`` operation. This could be useful if you</span>
<span class="token comment"># want to avoid duplicates in your start urls list. In this cases, urls must</span>
<span class="token comment"># be added via ``sadd`` command or you will get a type error from redis.</span>
<span class="token comment"># REDIS_START_URLS_AS_SET = True</span>

<span class="token comment"># Default start urls key for RedisSpider and RedisCrawlSpider.</span>
<span class="token comment"># REDIS_START_URLS_KEY = '%(name)s:start_urls'</span>

<span class="token comment"># Use other encoding than utf-8 for redis.</span>
<span class="token comment"># REDIS_ENCODING = 'utf-8'</span>
</code></pre></div><h2 id="items-py"><a href="#items-py" class="header-anchor">#</a> <strong>items.py</strong></h2> <p>初始化我们想获得的信息</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token comment"># Define here the models for your scraped items</span>
<span class="token comment">#</span>
<span class="token comment"># See documentation in:</span>
<span class="token comment"># https://docs.scrapy.org/en/latest/topics/items.html</span>

<span class="token keyword">import</span> scrapy


<span class="token keyword">class</span> <span class="token class-name">JdbookItem</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># define the fields for your item here like:</span>
    <span class="token comment"># name = scrapy.Field()</span>
    <span class="token comment"># 书名，大分类，小分类，小分类页面url，</span>
    <span class="token comment"># 详情页面url，作者，出版社，出版时间，价格</span>
    name <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    first_category <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    second_category <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    second_category_url <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cover_url <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    detail_url <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    author <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    publisher <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pub_date <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    price <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><h2 id="book-py"><a href="#book-py" class="header-anchor">#</a> <strong>book.py</strong></h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">'''
这个方法实现利用xpath先获取所有一级分类的selector list
再遍历一级分类获取所有二级分类的selector list
遍历二级分类提取出url
调用yield 生成scrapy.Request访问二级分类url,回调self.parse_bookpage
'''</span>

</code></pre></div><p><img src="https://img-blog.csdnimg.cn/20191007211948785.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0MTkyMDMy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">parse_bookpage</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token triple-quoted-string string">'''
这个方法实现获取当前二级分类下商品的所有页数，
构造每一页的url,
调用yield 生成scrapy.Request访问每一页url,回调self.parse_bookinfo
'''</span>

</code></pre></div><p><img src="https://img-blog.csdnimg.cn/20191007211958383.png" alt="在这里插入图片描述"></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">parse_bookinfo</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token triple-quoted-string string">'''
这个方法实现获取每本书的详细信息
实例化item
其中由于价格是异步加载的，
分析每个商品价格的接口url由'https://p.3.cn/prices/mgets?skuIds=J_' + skuid组成，skuid即data-sku
再调用yield 生成scrapy.Request访问价格url,回调parse_bookprice
'''</span>
</code></pre></div><p><img src="https://img-blog.csdnimg.cn/20191007212121783.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0MTkyMDMy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <div class="language-python extra-class"><pre class="language-python"><code> <span class="token keyword">def</span> <span class="token function">parse_bookprice</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
 <span class="token triple-quoted-string string">'''
 获取价格，
 yield item
 '''</span>
</code></pre></div><p><img src="https://img-blog.csdnimg.cn/20191007212027155.png" alt="在这里插入图片描述"> <strong>book.py完整代码</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy
<span class="token keyword">import</span> json
<span class="token keyword">from</span> jdbook<span class="token punctuation">.</span>items <span class="token keyword">import</span> JdbookItem
<span class="token keyword">from</span> scrapy_redis<span class="token punctuation">.</span>spiders <span class="token keyword">import</span> RedisSpider


<span class="token keyword">class</span> <span class="token class-name">BookSpider</span><span class="token punctuation">(</span>RedisSpider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'book'</span>
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'jd.com'</span><span class="token punctuation">,</span><span class="token string">'p.3.cn'</span><span class="token punctuation">]</span>
    redis_key <span class="token operator">=</span> <span class="token string">'book'</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#get first_category xpath selector list</span>
        <span class="token comment"># fc_list = response.xpath('//*[@id=&quot;booksort&quot;]/div[2]/dl/dt/a')</span>
        fc_list <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//*[@id=&quot;booksort&quot;]/div[2]/dl/dt[1]/a'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> fc_list<span class="token punctuation">:</span>
            <span class="token comment"># traverse first_category list ,get each first_category's name , url</span>
            <span class="token comment"># and second_category list</span>
            fc <span class="token operator">=</span> i<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
            sc_list <span class="token operator">=</span> i<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'../following-sibling::dd[1]/em/a'</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> n <span class="token keyword">in</span> sc_list<span class="token punctuation">:</span>
                <span class="token comment"># traverse second_category list,get each second_category's name,url</span>
                info <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                info<span class="token punctuation">[</span><span class="token string">'first_category'</span><span class="token punctuation">]</span> <span class="token operator">=</span> fc
                info<span class="token punctuation">[</span><span class="token string">'second_category'</span><span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
                info<span class="token punctuation">[</span><span class="token string">'second_category_url'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'https:'</span> <span class="token operator">+</span> n<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./@href'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
                <span class="token comment"># yield request second_category_url, callback=self.parse_bookinfo ,</span>
                <span class="token comment"># get each second_category's books info</span>
                <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>
                    info<span class="token punctuation">[</span><span class="token string">'second_category_url'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    callback <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_bookpage<span class="token punctuation">,</span>
                    meta <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'meta'</span><span class="token punctuation">:</span>info<span class="token punctuation">}</span>
                <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">parse_bookpage</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        info <span class="token operator">=</span> response<span class="token punctuation">.</span>meta<span class="token punctuation">[</span><span class="token string">'meta'</span><span class="token punctuation">]</span>
        lastpage <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//*[@id=&quot;J_bottomPage&quot;]/span[1]/a[9]/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">(</span>lastpage<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            url <span class="token operator">=</span><span class="token string">'https://list.jd.com'</span> <span class="token operator">+</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//*[@id=&quot;J_bottomPage&quot;]/span[1]/a[2]/@href'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
            url <span class="token operator">=</span> url<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'page=1'</span><span class="token punctuation">,</span><span class="token string">'page='</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
            
            <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>
                url<span class="token punctuation">,</span> 
                callback <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_bookinfo<span class="token punctuation">,</span>
                meta<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'meta'</span><span class="token punctuation">:</span>info<span class="token punctuation">}</span>
            <span class="token punctuation">)</span> 

    <span class="token comment"># parse_bookinfo</span>
    <span class="token keyword">def</span> <span class="token function">parse_bookinfo</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># get response.meta</span>
        info <span class="token operator">=</span> response<span class="token punctuation">.</span>meta<span class="token punctuation">[</span><span class="token string">'meta'</span><span class="token punctuation">]</span>
        <span class="token comment"># get book xpath selector list</span>
        book_list <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//*[@id=&quot;plist&quot;]/ul/li/div'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> book_list<span class="token punctuation">:</span>
            item <span class="token operator">=</span> JdbookItem<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'first_category'</span><span class="token punctuation">]</span> <span class="token operator">=</span> info<span class="token punctuation">[</span><span class="token string">'first_category'</span><span class="token punctuation">]</span>
            item<span class="token punctuation">[</span><span class="token string">'second_category'</span><span class="token punctuation">]</span> <span class="token operator">=</span> info<span class="token punctuation">[</span><span class="token string">'second_category'</span><span class="token punctuation">]</span>
            item<span class="token punctuation">[</span><span class="token string">'second_category_url'</span><span class="token punctuation">]</span> <span class="token operator">=</span> info<span class="token punctuation">[</span><span class="token string">'second_category_url'</span><span class="token punctuation">]</span>
            item<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div[3]/a/em/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'detail_url'</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token string">'https:'</span><span class="token operator">+</span> i<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div[1]/a/@href'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'author'</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div[4]/span[1]/span/a/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'publisher'</span><span class="token punctuation">]</span> <span class="token operator">=</span>i<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div[4]/span[2]/a/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'pub_date'</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div[4]/span[3]/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            skuid <span class="token operator">=</span> i<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./@data-sku'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            url <span class="token operator">=</span> <span class="token string">'https://p.3.cn/prices/mgets?skuIds=J_'</span> <span class="token operator">+</span> skuid

            <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>
                url<span class="token punctuation">,</span> 
                callback <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_bookprice<span class="token punctuation">,</span>
                meta <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'meta'</span><span class="token punctuation">:</span>item<span class="token punctuation">}</span>
                <span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">parse_bookprice</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># get price</span>
        item <span class="token operator">=</span> response<span class="token punctuation">.</span>meta<span class="token punctuation">[</span><span class="token string">'meta'</span><span class="token punctuation">]</span>
        data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
        item<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'0'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'op'</span><span class="token punctuation">]</span>
        <span class="token keyword">yield</span> item

</code></pre></div><p>开3个终端模拟分布式，吃个饭的时间，爬了25000条，小说分类还没爬完，上个成果图，后续可以将redis中的数据写入到MySQL、Mongodb中。</p> <p><img src="https://img-blog.csdnimg.cn/20191007212143360.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0MTkyMDMy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h2 id="完整代码"><a href="#完整代码" class="header-anchor">#</a> 完整代码</h2> <p><a href="https://github.com/duziea/Python-imitate-login/tree/master/JDmail/book/jdbook" target="_blank" rel="noopener noreferrer">https://github.com/duziea/Python-imitate-login/tree/master/JDmail/book/jdbook<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/python/" class="prev router-link-active">前言</a></span> <span class="next"><a href="/python/scrapy-redis源码解读.html">scrapy-redis源码解读</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.dabac77d.js" defer></script><script src="/assets/js/2.b1acc2ad.js" defer></script><script src="/assets/js/20.279c30ab.js" defer></script>
  </body>
</html>
